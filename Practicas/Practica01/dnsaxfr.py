#!/usr/bin/python
## Necesario el modulo dnspython
## pip install dnspython
import dns.resolver
import dns.query
import dns.zone
import os
import sys

# Consulta de transferencia de zona automatica
def dnsaxfr(domain):
  domain = domain.strip()
  print("********************************************" )
  print("*** INICIO DOMINIO : " + domain )
  print("********************************************" )
  try:
    ns_query = dns.resolver.query(domain,'NS')
    print("********************************************" )
    print("*** SERVIDORES DNS : " )
    print ns_query.rrset
    print("********************************************" )
    for ns in ns_query.rrset:
      nameserver = str(ns)[:-1]
      if nameserver is None or nameserver == "":
        continue

      try:
        axfr = dns.query.xfr(nameserver, domain, lifetime=5)
        try:
          zone = dns.zone.from_xfr(axfr)
          if zone is None:
            continue
          print("********************************************" )
          print("*** EXITO: " + domain + " @ " + nameserver )
          print("********************************************" )
          for name, node in zone.nodes.items():
            rdatasets = node.rdatasets
            for rdataset in rdatasets:
              print(str(name) + " " + str(rdataset) )
        except Exception as e:
          continue
      except Exception as e:
        continue
  except Exception as e:
    pass
  print("********************************************" )
  print("FIN: " + domain )
  print("********************************************" )

# Leemos del archivo los dominios
def fromFile(domains):
  f = open(domains, 'r')
  for line in f:
      domain = line[:-1]
      dnsaxfr(domain)
  f.close()  
  

if __name__ == '__main__':
  #main()
  fromFile("sites");  
